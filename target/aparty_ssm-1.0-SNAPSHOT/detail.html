<!DOCTYPE html>
<html lang="zh">
    <head>
        <meta charset="utf-8" />
<!--        <meta name="viewport" content="width=device-width, initial-scale=1.0">-->
        <!--禁止缩放-->
        <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0;" name="viewport" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge">

        <title>编写</title>
        <link rel="stylesheet" href="css/style.css" />
        <link rel="stylesheet" href="css/editormd.preview.css" />
        <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" />
        <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
        <link rel="stylesheet" type="text/css" href="css/sui.nav.css" />
        <link rel="stylesheet" type="text/css" href="css/index.css" />
        <link rel="stylesheet" type="text/css" href="css/detail.css" />

        <script src="js/jquery.min.js"></script>
        <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
        <script src="http://cdn.bootcss.com/bootstrap-hover-dropdown/2.0.10/bootstrap-hover-dropdown.min.js"></script>
        <script src="js/sui.nav.min.js" type="text/javascript" charset="utf-8"></script>

    </head>
    <body>
        <div id="layout" class="app">
            <!-- 头部 -->
            <header>
                <!-- navbar-fixed-top 固定在顶部 inavbar-default -->
                <nav class="navbar navbar-default  navbar-fixed-top" style="position: absolute;">
                    <div class="container-fluid icontainer-fluid container">
                        <!-- Brand and toggle get grouped for better mobile display -->
                        <div class="navbar-header inavbar-header">
                            <!-- data-toggle="collapse" -->
                            <button type="button" class="navbar-toggle collapsed icollapsed MenuToggle" data-target="#bs-example-navbar-collapse-1"
                                    aria-expanded="false">
                                <span class="sr-only">Toggle navigation</span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                            </button>
                            <!-- logo -->
                            <a class="logo_a" href="/">
                                <img class="inavbar-brand" src="img/logo4.png" alt="">
                                <b>很方</b>
                            </a>

                        </div>

                        <!-- Collect the nav links, forms, and other content for toggling -->
                        <div class="collapse  navbar-collapse" id="bs-example-navbar-collapse-1" style="margin-right: 50px;">

                            <ul class="nav navbar-nav  navbar-right">
                                <li v-if="user.head === undefined" >
                                    <a href="login.html">登录</a>
                                </li>

                                <li class="dropdown"  v-show="user.head != undefined" style="margin-right: -20px;margin-left: 10px;">
                                    <!-- 通过data-delay设置下拉框消失的时间 -->
                                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" data-hover="dropdown" data-delay="50" role="button" aria-haspopup="true" aria-expanded="false" style="padding: 5px 0 2px 5px;">
                                        <img :src="user.head" alt="头像" height="40" width="40" style="border-radius: 2em;">
                                        <span class="caret"></span>
                                    </a>
                                    <ul class="dropdown-menu idropdown-menu" style="margin-right: -104px;margin-top: 5px;">
                                        <li><a href="personal.html"><span class="glyphicon glyphicon-user"></span> 我的主页</a></li>
                                        <li><a href="personal.html#col"><span class="glyphicon glyphicon-list-alt"></span>收藏的文章</a></li>
                                        <li><a href="personal.html#art"><span class="glyphicon glyphicon-copyright-mark"></span>我的文章</a></li>
                                        <li role="separator" class="divider"></li>

                                        <li><a href="#" @click.prevent="exit"><span class="glyphicon glyphicon-log-out"></span>退出</a></li>
                                    </ul>
                                </li>

                                <!-- <li><a href="#">注册</a></li> -->
                            </ul>


                            <form class="navbar-form navbar-right">
                                <div class="form-group">
                                    <input type="text" class="form-control" placeholder="站内搜索">
                                </div>
                                <button type="submit" class="btn btn-default  glyphicon glyphicon-search"></button>
                            </form>

                            <ul class="nav navbar-nav navbar-right">
                                <li><a href="#"><span class="glyphicon glyphicon-home"></span> 首页 </a></li>
                                <li><a href="articleeditor.html" target="_blank">写文章</a></li>
                                <li><a href="#">Link1</a></li>
                                <li><a href="#">Link2</a></li>

                            </ul>

                        </div><!-- /.navbar-collapse -->
                    </div><!-- /.container-fluid -->


                    <!-- 侧边栏 -->
                    <div id="sui_nav" class="sui-nav horizontal navbar-default">
                        <div class="sui-nav-wrapper nav-border nav-line">
                            <ul>
                                <li>
                                    <!-- logo -->
                                    <a class="logo_a" href="#" style="margin-left: -125px">
                                        <img class="inavbar-brand" src="img/logo4.png" alt="">
                                        <b>很方</b>
                                    </a>
                                </li>

                                <li><a class="text-primary" style="margin-left: -160px" href="/" onclick="event.stopPropagation()"  ><span class="glyphicon glyphicon-home"></span> 首页</a></li>
                                <li><a class="text-danger " href="articleeditor.html" onclick="event.stopPropagation()" style="margin-left: -150px"><span class="glyphicon glyphicon-fire"></span> 写文章</a></li>
                            </ul>

                            <ul class="pull-right">
                                <!-- <li><a class="text-success">注册</a></li> -->
                                <li v-if="user.head === undefined" style="margin-left: -150px;">
                                    <a class="text-success" onclick="event.stopPropagation()" href="login.html">登录</a>
                                </li>
                                <li v-else style="margin-left: -25px;">
                                    <img :src="user.head" alt="头像" height="45" width="45" style="border-radius: 2em;">
                                    <span class="glyphicon glyphicon-hand-right" style="margin-left: 120px;"></span>
                                    <!--下拉-->
                                    <ul style="margin-left: -80px;">
                                        <li ><a href="personal.html" onclick="event.stopPropagation()"><span class="glyphicon glyphicon-user"></span> 我的主页</a></li>
                                        <li style="margin-left: 10px;"><a href="personal.html#col" onclick="event.stopPropagation()"><span class="glyphicon glyphicon-list-alt"></span> 收藏的文章</a></li>
                                        <li ><a href="personal.html#art" onclick="event.stopPropagation()"><span class="glyphicon glyphicon-copyright-mark"></span> 我的文章</a></li>
                                        <!--<li><a href="#"><span class="glyphicon glyphicon-registration-mark"></span> 我是R</a></li>-->
                                        <li style="margin-left: -25px;"><a href="#" onclick="exit()" ><span class="glyphicon glyphicon-log-out"></span> 退出</a></li>
                                    </ul>
                                </li>


                            </ul>
                        </div>
                    </div>

                </nav>
            </header>

            <div class="dma">
                <!--左边-->
                <div class="dle">
                    <div>
                        <!--收藏-->
                        <div :class="collectState ? 'dcollect yellow-coll' : 'dcollect'">
                            <span data-toggle="tooltip" @click="collect(article.aid)" class="glyphicon glyphicon-magnet" data-placement="right" title="收藏"></span>
                        </div>
                    </div>
                </div>

                <!--中间-->
                <div class="dmi">

                    <div class="btns">
        <!--                <button onclick="location.href='./html-preview-markdown-to-html-custom-toc-container.html';">将 ToC 移到自定义容器层</button>-->
                    </div>

                    <ul class="breadcrumb" style="margin-top: 30px;margin-bottom: 5px;">
                        <li><a href="/"  >首页</a></li>
<!--                        <li><a href="#">文章</a></li>-->
                        <li class="active" v-text="article.title"></li>
                    </ul>
                    <!--正文部分 margin-top: 30px; -->
                    <div id="test-editormd-view" style="border: 1px solid #EAEAEA;border-radius: 4px; ">

                        <div class="iTitle">
                            <h1 v-text="article.title"></h1>
                            <div style="text-align: center;" class="xx">
                                 <span><i class="glyphicon glyphicon-time"></i><span v-text="formatDate(article.releaseTime)">2020-03-21 17:04:50</span></span>
                                 <span><i class="glyphicon glyphicon-list"></i><span v-text="article.labelString">Linux</span></span>
                                 <span><i class="glyphicon glyphicon-fire"></i><span v-text="article.pageView">一亿</span></span>
                                 <span><a href="#dComment"><i class="glyphicon glyphicon-comment"></i><span v-if="article.commentList" v-text="article.commentList.length"></span></a></span>
                            </div>
                        </div>
                       <textarea style="display:none;" name="test-editormd-markdown-doc"></textarea>
                    </div>


                    <!--评论-->
                    <div class="dComment" id="dComment">
                        <h2>评论</h2>
                        <form role="form" class="root-form" v-show="user.head != undefined">
                            <input type="hidden" :value="article.aid" name="aid">
                            <div class="form-group">
                                <label for="commentContent"><img :src="user.head" alt="头像"></label>
                                <textarea class="form-control" rows="3" style="resize: none;"  name="commentContent" id="commentContent" placeholder="下一个神评就是你"></textarea>
                            </div>
                            <button type="submit" @click.prevent="rootForm" class="btn btn-default " style=" float:right;">提交</button>
                        </form>
                        <div class="well well-lg" v-show="user.head == undefined">请先<a href="login.html"><strong>登录</strong></a>，在来评论</div>

                        <div class="observer" v-if="article.commentList && article.commentList.length > 0">
                            <div class="page-header root-comment" v-for="(comment,i) in article.commentList">
                                <form  :class="SplicingClass(i+1)">
                                    <div id="" style="word-wrap:break-word;width: 100%;">
                                        <a :href="joinsubst(comment.user.uid)">
                                            <img :src="comment.user.head" alt="" align="left" style="vertical-align: middle;">
                                            <p v-text="comment.user.username" class="user-name">哈哈哈哈</p>
                                        </a>
                                        <p v-text="formatDateYr(comment.commentTime)" class="user-time">2020</p>
                                        <p v-text="comment.commentContent" class="comment-content" style="margin-left: 28px;margin-bottom: 0px;"></p>
                                        <a href="" style="float: right;margin-top: -10px;"  @click.prevent="addText(i+1)">回复</a> <br>
                                        <div class="sub">
                                            <input type="hidden" name="aid" :value="article.aid">
                                            <input type="hidden" name="rid" :value="comment.cid">
                                            <input type="hidden" name="cid" :value="comment.cid">
                                            <textarea  name="commentContent" class="text-form"  rows="3" placeholder="快来评论~~"></textarea>
                                            <button type="submit" @click.prevent="present(i+1)" class="btn btn-default " style=" float:right;">提交</button>
                                        </div>
                                    </div>
                                </form>
                                <hr style="margin-left: 35px;margin-top: 0px;margin-bottom: 5px;">

                                <!--回复-->
                                <div class="page-header" v-for="(reply,j) in comment.replyList" v-if="comment.replyList.length > 0" style="margin-left: 35px;">
                                    <form :class="replyClass(i+1,j+1)">
                                        <div style="word-wrap:break-word;width: 100%;">
                                            <a :href="joinsubst(reply.user.uid)">
                                                <img :src="reply.user.head" alt="" align="left">
                                                <p v-text="reply.user.username" class="user-name"></p>
                                            </a>
                                            <p v-text="formatDateYr(reply.commentTime)" class="user-time"></p>
                                            <!--评论内容-->
                                            <p class="comment-content" style="margin-left: 28px;"><span>@{{comment.user.username}}</span>&nbsp;<span v-text="reply.commentContent"></span> </p>
                                            <a href="" style="float: right;margin-top: -30px;"   @click.prevent="replyText(i+1,j+1)">回复</a>
                                            <div class="sub">
                                                <input type="hidden" name="aid" :value="article.aid">
                                                <input type="hidden" name="rid" :value="comment.cid">
                                                <input type="hidden" name="cid" :value="reply.cid">
                                                <textarea  name="commentContent" class="text-form"  rows="3" placeholder="写你想写，看你所看~~"></textarea>
                                                <button type="submit" @click.prevent="replyPresent(i+1,j+1)" class="btn btn-default " style=" float:right;">提交</button>
                                            </div>
                                        </div>
                                    </form>
                                    <hr style="margin-left: 35px;margin-top: 0px;margin-bottom: 5px;">

                                    <!--再回复-->
                                    <div class="page-header" v-for="replys in reply.replyList" v-if="reply.replyList.length > 0" style="margin-left: 45px;">
                                        <a :href="joinsubst(replys.user.uid)">
                                            <img :src="replys.user.head" alt="">
                                        </a>
                                        <div style="display: inline-block;">
                                            <a :href="joinsubst(replys.user.uid)">
                                                <p v-text="replys.user.username" class="user-name"></p>
                                            </a>
                                            <p v-text="formatDateYr(replys.commentTime)" class="user-time"></p>
                                            <!--评论内容-->
                                            <p class="comment-content"><span>@{{reply.user.username}}</span>&nbsp;<span v-text="replys.commentContent"></span></p>
                                        </div>
<!--                                        <a href="" style="float: right;">回复</a>-->
                                        <hr style="margin-left: 35px;margin-top: 0px">

                                    </div>

                                </div>

                            </div>

                        </div>
                        <div v-else>
                            <h3>暂无评论</h3>
                        </div>

                    </div>

                </div>

                <!--右边-->
                <div class="dri">
                    <!--作者信息-->
                    <div class="iota"  v-if="article.user != undefined">
                        <div class="iota-top">
                            <a :href="joinsubst(article.user.uid)">
                                <img  width="50"  :src="article.user.head" alt="">
                                <div class="iota-user-name" > <b v-text="article.user.username"></b></div>
                            </a>

                        </div>
                        <div class="iota-buttom">
                            <p><a href="#">粉丝<span class="badge" v-text="article.user.numberOfConcerns">50</span></a>&nbsp;<a href="#">关注<span class="badge" v-text="article.user.concernNumber">50</span></a> </p>
                            <span style="cursor: pointer;" @click="attentionTa" v-if="user.uid != article.user.uid ">关注<i v-if="attentionState" class="glyphicon glyphicon-ok"></i></span>
                        </div>
                    </div>
                </div>

            </div>

            <div class="back-to-the-top dback-to-the-top" >
                <i class="glyphicon glyphicon-chevron-up"></i>
                <a href="/"><i class="glyphicon glyphicon-home"></i></a>
                <i class="glyphicon glyphicon-chevron-down"></i>
            </div>

        </div>
        <!-- <script src="js/zepto.min.js"></script>
		<script>
			var jQuery = Zepto;  // 为了避免修改flowChart.js和sequence-diagram.js的源码，所以使用Zepto.js时想支持flowChart/sequenceDiagram就得加上这一句
		</script> -->

        <script src="lib/marked.min.js"></script>
        <script src="lib/prettify.min.js"></script>
        
        <script src="lib/raphael.min.js"></script>
        <script src="lib/underscore.min.js"></script>
        <script src="lib/sequence-diagram.min.js"></script>
        <script src="lib/flowchart.min.js"></script>
        <script src="lib/jquery.flowchart.min.js"></script>
        <script src="js/editormd.min.js"></script>

        <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
        <script src="js/axios.min.js"></script>
        <script type="text/javascript">
            /*提示工具*/
            $(function () { $("[data-toggle='tooltip']").tooltip(); });

            var testEditormdView, testEditormdView2,topbar;


            editormd.emoji     = {
                path  : "./images/emoji/",
                ext   : ".png"
            };


            var vueApp = new Vue({
                el: "#layout",
                data: {
                    user: {},
                    article: {},
                    collectState: false,
                    attentionState: false,
                },
                created: function(){
                    const _this = this;

                    this.part();

                    //是否登录
                    axios.get("user/thelogin").then(function (value) {
                        _this.user = value.data;
                    }).catch(function (error) {

                    });


                    //当前用户是否收藏文章
                    axios.get("collect/"+getUrlParam("id")).then(function (resp) {
                        if (resp.status === 200){
                            $(".dle span").attr("title","已收藏");
                            $(".dle span").attr("data-original-title","已收藏");
                            _this.collectState = true;
                        }
                    });

                    window.onscroll = function () {
                        //变量scrollTop是滚动条滚动时，距离顶部的距离
                        var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
                        //变量windowHeight是可视区的高度
                        var windowHeight = document.documentElement.clientHeight || document.body.clientHeight;
                        //变量scrollHeight是滚动条的总高度
                        var scrollHeight = document.documentElement.scrollHeight || document.body.scrollHeight;

                        if (scrollTop + windowHeight > 1800) {
                            $(".back-to-the-top .glyphicon-chevron-up").css("display", "block");
                        } else {
                            $(".back-to-the-top .glyphicon-chevron-up").css("display", "none");
                        }

                    }

                },
               watch: {
                    article(){
                        let _this=this;
                        var uid=this.article.user.uid;
                        //是否关注
                        axios.get("attention/"+uid).then(function (resp) {
                            if (resp.status === 200){
                                _this.attentionState = true;
                            }
                        });
                    }
               },
                methods:{
                    joinsubst: function(id){
                      return "substituti.html?id="+id;
                    },
                    exit:function(){
                        var _this = this;
                        axios.get("user/exit").then(function (resp) {
                            if (resp.status === 200){
                                _this.user = {};
                            }
                        })
                    },
                    formatDate: function (value) {
                        let date = new Date(value);
                        let y = date.getFullYear();
                        let MM = date.getMonth() + 1;
                        MM = MM < 10 ? ('0' + MM) : MM;
                        let d = date.getDate();
                        d = d < 10 ? ('0' + d) : d;
                        let h = date.getHours();
                        h = h < 10 ? ('0' + h) : h;
                        let m = date.getMinutes();
                        m = m < 10 ? ('0' + m) : m;
                        let s = date.getSeconds();
                        s = s < 10 ? ('0' + s) : s;
                        return y + '-' + MM + '-' + d + ' ' + h + ':' + m + ':' + s;
                    },
                    formatDateYr: function (value) {
                        let date = new Date(value);
                        let y = date.getFullYear();
                        let MM = date.getMonth() + 1;
                        MM = MM < 10 ? ('0' + MM) : MM;
                        let d = date.getDate();
                        d = d < 10 ? ('0' + d) : d;
                        let h = date.getHours();
                        h = h < 10 ? ('0' + h) : h;
                        let m = date.getMinutes();
                        m = m < 10 ? ('0' + m) : m;
                        let s = date.getSeconds();
                        s = s < 10 ? ('0' + s) : s;
                        return  MM + '-' + d + ' ' + h + ':' + m + ':' + s;
                    },
                    /*评论*/
                    rootForm: function () {
                        axios.post("comment",$(".root-form").serialize()).then(function (value) {
                            window.location.reload();
                        }).catch(function (error) {

                        });
                    },
                    SplicingClass : function (i) {
                        return "root-form-" + i;
                    },
                    replyClass : function (i,j) {
                        return "reply-form-"+ i +"-" + j;
                    },

                    addText : function (i) {
                       $(".root-form-"+i + " .sub").css("display","block");
                    },
                    replyText : function (i,j) {
                        $(".reply-form-"+i+"-"+j + " .sub").css("display","block");
                    },

                    /*评论*/
                    present : function (i) {
                        axios.post("comment",$(".root-form-"+i).serialize()).then(function (value) {
                            window.location.reload();
                        })
                    },
                    replyPresent : function (i,j) {
                        axios.post("comment",$(".reply-form-"+i+"-"+j).serialize()).then(function (value) {
                            window.location.reload();
                        })
                    },
                    /*收藏*/
                    collect : function (aid) {
                        var _this = this;

                        if($.isEmptyObject(this.user)){
                            alert("您还没有登录");
                            return;
                        }

                        if (!this.collectState){
                            axios.post("collect",{"aid":aid}).then(function (resp) {
                                if (resp.status === 201){
                                    $(".dle span").attr("title","已收藏");
                                    $(".dle span").attr("data-original-title","已收藏");
                                    _this.collectState = true;
                                }
                            })
                        }else{
                            //取消收藏
                            axios.delete("collect/"+aid).then(function (resp) {
                                    $(".dle span").attr("title","收藏");
                                    $(".dle span").attr("data-original-title","收藏");
                                    _this.collectState = false;
                            })
                        }
                    },

                    /*关注*/
                    attentionTa: function(){
                        var _this = this;

                        if($.isEmptyObject(this.user)){
                            alert("您还没有登录");
                            return;
                        }

                        if (!this.attentionState){
                            axios.post("attention",{"auid":_this.article.user.uid}).then(function (resp) {
                                if (resp.status === 201) {
                                    _this.article.user.numberOfConcerns =  _this.article.user.numberOfConcerns + 1;
                                    _this.attentionState = true;
                                }
                            })
                         }else{
                            //取消关注
                            axios.delete("attention/"+_this.article.user.uid).then(function (value) {
                                if ( _this.article.user.numberOfConcerns > 0){
                                    _this.article.user.numberOfConcerns =  _this.article.user.numberOfConcerns - 1;
                                }
                                _this.attentionState = false;
                            })
                        }
                       },

                    part : function () {
                        var _this = this;
                        axios.get("article/"+getUrlParam("id")).then(function (resp) {
                            _this.article = resp.data;

                            testEditormdView = editormd.markdownToHTML("test-editormd-view", {
                                markdown        : resp.data.content ,//+ "\r\n" + $("#append-test").text(),
                                //htmlDecode      : true,       // 开启 HTML 标签解析，为了安全性，默认不开启
                                htmlDecode      : "style,script,iframe",  // you can filter tags decode
                                tocm            : true,    // Using [TOCM]
                                // markdownSourceCode : true, // 是否保留 Markdown 源码，即是否删除保存源码的 Textarea 标签
                                emoji           : true,
                                taskList        : true,
                                tex             : true,  // 默认不解析
                                flowChart       : true,  // 默认不解析
                                sequenceDiagram : true // 默认不解析
                            });
                        });
                    }

                }

            }); // vue end


            $(function() {

                topbar = $('#sui_nav').SuiNav({});
                var navbar = $('#sui_nav2').SuiNav({});
                $('.MenuToggle').click(function() {
                    console.log("toggle");
                    topbar.toggle();
                });
                $('.MenuOpen').click(function() {
                    console.log("open");
                    topbar.show();
                });

            });

            //获取地址栏参数方法
            function getUrlParam(name) {
                var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
                var r = window.location.search.substr(1).match(reg);  //匹配目标参数
                if (r != null) return unescape(r[2]); return null; //返回参数值
            }


            /* 去顶部 */
            $('.back-to-the-top .glyphicon-chevron-up').on('click', function () {
                $('html,body').animate({
                    scrollTop: 0
                }, 'slow'); //缓慢动画
            });

            /* 去底部 */
            $('.back-to-the-top .glyphicon-chevron-down').on('click', function () {
                /* $('html,body,#box').scrollTop(9999); */
                $('html,body').animate({
                    scrollTop: $('#dComment').offset().top
                }, 'slow');
            });

            function exit() {
                vueApp.exit();
            };

        </script>
    </body>
</html>